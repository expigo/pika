name: Deploy to Staging

on:
  push:
    branches:
      - staging
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'
      - '.gitignore'

jobs:
  deploy:
    name: Deploy to VPS (Staging)
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_key }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "ðŸš€ Starting Staging Deployment..."
            
            # Ensure the directory exists (create if first run)
            mkdir -p /opt/pika/pika-staging
            
            # Navigate to staging directory
            cd /opt/pika/pika-staging
            
            # Check if it's currently a git repo; if not, clone it
            if [ ! -d ".git" ]; then
              echo "Cloning repository for the first time..."
              # Clone only the staging branch
              git clone -b staging git@github.com:expigo/pika.git . || git clone -b staging https://github.com/expigo/pika.git .
            fi
            
            # 1. Get latest code
            git fetch origin staging
            git reset --hard origin/staging
            
            # 2. Rebuild and Restart Staging Services
            # We use project-name 'pika-staging' to avoid conflict with prod default project
            docker compose -f docker-compose.staging.yml -p pika-staging down
            docker compose -f docker-compose.staging.yml -p pika-staging up -d --build --force-recreate
            
            # 3. Prune old images
            docker image prune -f
            
            echo "âœ… Staging Deployment Complete!"
